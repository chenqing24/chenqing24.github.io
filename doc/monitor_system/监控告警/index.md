# 监控告警体系

<!-- toc -->

## 目的

介绍常用的监控告警模式和实现方案

## 架构组件

### 采集体系

#### 指标的分类分层

采集指标分为3类：

1. 维度指标：即时某个采集项的状态值，也可以是聚合计算后的值，如：主机当前负载、5分钟平均负载
2. 业务输出log：是业务组件按照约定格式输出的log，既可以反馈某个错误详细（如java的Exception），也可以统计业务状态（如accesslog的4xx|5xx状态比例）
3. Tracing：特定的log，用于APM，能按照业务访问链路的时序，发现耗时异常的问题点

层级自顶向下，依次为：

| 层级 | 常见采集项 | 敏感度 | 故障紧急度 |
| ---- | ---- | ---- | ---- |
| 用户体验层 | 页面存活、响应耗时 | 高 | 高 |
| 业务层 | 业务自定义指标 | 中 | 高 |
| APP层 | 错误log量、请求状态码比例、接口响应耗时 | 中 | 高 |
| OS层 | 负载、容量、IO速度 | 高 | 低 |
| 基础设施层 | 硬件状态、网络拓扑和流量等 | 高 | 低 |

### 告警规则

告警规则 = 查询条件+触发条件+事件定义

* 查询条件：指定采集指标，和过滤约束条件，如：时间范围、主机范围指定，支持多重条件复合
* 触发条件：选择计算的范式，与阈值对比
  * 计算的范式：一种计算的表达式|宏定义，可以用模板包装
  * 阈值：预先定义好的，用于对比的值|对象，分静态和动态
* 事件定义：触发后的事件等级、发送的报文格式等，推送给指定的通知服务

### 通知服务

事件一览 + 告警事件的通知渠道 + 事件处理和升级流程 + Hook机制

* 事件一览：所有收到的事件，按照条件显示
* 通知渠道：多种外部通知方式，如：邮件、微信通知接口、电话
* 事件处理和升级流程：
  * 事件处理：
    * 信息补全：服务从事件报文中抽取关键key，通过查询CMDB，进一步补全事件完整信息，如：该事件属于哪个APP（BU）、负责人是谁、上下游服务是谁、同类告警的处理提示，可以不断完善
    * 告警收敛：
      * 事件聚合：同类事件合并为1个告警
      * 事件静默：已经发送过的告警，同类新事件在指定一段时期内不再发送告警
    * 告警确认：
      * 用户处理：运维或其他负责人，通过界面或接口，确认处理某个告警，然后关闭该告警
      * 自动关闭：没有持续收到同类事件、或者收到恢复事件，将对应的告警自动关闭
  * 事件升级：同类事件聚合形成告警，告警一直未被处理，一段时间后通知该服务的上级负责人，事件严重等级可能会提升
* Hook机制：可选，用于组建自动处理pipeline，如某个APP死机后，通过hook，传入APP的key，自动调用APP重启接口

### 可视化

[TODO]

## 元模型

### 采集指标库

| 字段名 | 类型 | 范式 | 备注 |
| ---- | ---- | ---- | ---- |
| name | String | 唯一 | 指标唯一名 |
| cname | String |  | 中文名 |
| meaning | String | 必填 | 指标含义 |
| calc_formula | String |  | 采集计算公式 |
| rel_unit | 字典 |  | 数据单位，从字典：单位 中选择 |
| rel_level | 字典 | 必填 | 所属层级，从字典：层级 中选择 |
| rel_type | 字典 | 必填 | 采集类型，从 Metric、Log、APM 中选择 |
| namespace | String | 默认default | 命名空间 |

对不同的采集类型，实现的方式是

### 告警规则库

| 字段名 | 类型 | 范式 | 备注 |
| ---- | ---- | ---- | ---- |
| name | String | 唯一 | 指标唯一名 |
